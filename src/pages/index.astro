---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '@/data/site';
import { getPath } from '@/utils/paths';

const allProjects = await getCollection('projects');

// Helper for random positioning
const getRandomPos = () => ({
  top: Math.floor(Math.random() * 60) + 10 + '%',
  left: Math.floor(Math.random() * 70) + 5 + '%',
  rotation: Math.floor(Math.random() * 40) - 20 + 'deg',
});
---

<BaseLayout
  title={`${siteConfig.name} | ${siteConfig.title}`}
  description={siteConfig.description}
>
  <div class="min-h-screen relative overflow-hidden">
    <!-- Massive Background Title -->
    <h1 class="font-display font-black text-[15vw] leading-none absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-0 opacity-10 select-none whitespace-nowrap">
      IMPRESSA
    </h1>

    <!-- Chaotic Project Gallery -->
    <div class="relative z-10 w-full min-h-[120vh]">
      {allProjects.map((project, index) => {
        const pos = getRandomPos();
        return (
          <div
            class="project-card-container absolute group block hover:z-50"
            style={`top: ${pos.top}; left: ${pos.left}; --rotation: ${pos.rotation};`}
          >
            <a href={getPath(`/work/${project.slug}/`)} class="block w-full h-full pointer-events-auto decoration-none">
            <div class="interactive-card bg-white border-4 border-black p-4 w-64 md:w-80 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] group-hover:shadow-[16px_16px_0px_0px_rgba(0,0,0,1)] transition-shadow">
              <div class="bg-black text-white p-2 mb-2 font-mono text-xs uppercase flex justify-between">
                <span>PROJECT_{String(index + 1).padStart(2, '0')}</span>
                <span>[OPEN]</span>
              </div>
              
              <div class="drag-handle aspect-video bg-gray-200 mb-2 overflow-hidden grayscale relative group-hover:grayscale-0 transition-none">
                <div class="absolute inset-0 bg-[url('/noise.png')] opacity-0 group-hover:opacity-50 mix-blend-overlay z-10 pointer-events-none"></div>
                {/* Fallback pattern if no image */}
                <div class="w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIi8+CjxwYXRoIGQ9Ik0wIDBMIHggOCA4IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMSIvPgo8cGF0aCBkPSJNOCAwTCAwIDgiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg==')] opacity-20 pointer-events-none"></div>
              </div>
              
              <h2 class="font-display text-2xl uppercase leading-none break-words group-hover:text-white group-hover:bg-black transition-colors">
                {project.data.title}
              </h2>
              <p class="font-mono text-xs mt-2 line-clamp-2">
                {project.data.description}
              </p>
            </div>
            </a>
          </div>
        );
      })}

      <!-- Shuffle Control -->
      <button id="shuffle-btn" class="fixed bottom-8 right-8 z-50 bg-black text-white border-4 border-white p-4 font-display text-xl uppercase hover:bg-white hover:text-black hover:border-black transition-colors shadow-[8px_8px_0px_0px_rgba(255,255,255,1)] hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
        RANDOMIZE_LAYOUT_[]
      </button>

      <!-- Intro Card (Fixedish) -->
      <div class="absolute top-20 left-10 md:left-20 max-w-md bg-black text-white p-8 border-4 border-white rotate-2 z-20 hover:rotate-0 transition-transform">
        <h2 class="font-display text-4xl mb-4 text-white">
          Warning:<br>High Content
        </h2>
        <p class="font-mono text-sm leading-relaxed mb-4">
          This portfolio contains raw, unrefined ideas and brutalist execution. 
          Proceed with caution.
        </p>
        <div class="animate-pulse font-mono text-xs text-primary">
           SYSTEM STATUS: ONLINE
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Interactive 3D Tilt and Parallax Logic
  
  function getRandomPos() {
    return {
      top: Math.floor(Math.random() * 60) + 10 + '%',
      left: Math.floor(Math.random() * 70) + 5 + '%',
      rotation: Math.floor(Math.random() * 40) - 20 + 'deg',
    };
  }

  const shuffleBtn = document.getElementById('shuffle-btn');
  if (shuffleBtn) {
    shuffleBtn.addEventListener('click', () => {
      const cards = document.querySelectorAll('.project-card-container');
      cards.forEach(card => {
        const pos = getRandomPos();
        const el = card as HTMLElement;
        el.style.top = pos.top;
        el.style.left = pos.left;
        el.style.setProperty('--rotation', pos.rotation);
      });
    });
  }
  
  // Parallax Effect on Container
  document.addEventListener('mousemove', (e) => {
    const cards = document.querySelectorAll('.project-card-container');
    const mouseX = e.clientX / window.innerWidth - 0.5;
    const mouseY = e.clientY / window.innerHeight - 0.5;

    cards.forEach((card, index) => {
      const depth = (index % 5) + 1; // Varying depth
      const moveX = mouseX * depth * 30; // Movement range
      const moveY = mouseY * depth * 30;
      
      const el = card as HTMLElement;
      // We start with the random rotation/position derived from CSS/Attributes
      // But since we can't easily parse consistent "random" CSS in JS without state,
      // We rely on the transform we set in the setTransform wrapper or CSS.
      // Actually, simplest way is to apply translation to a wrapper or add to existing transform?
      // Let's use CSS variables for the parallax offset to not overwrite the base rotation/position!
      
      el.style.setProperty('--parallax-x', `${moveX}px`);
      el.style.setProperty('--parallax-y', `${moveY}px`);
    });
  });

  // 3D Tilt Effect on Hover
  document.querySelectorAll('.interactive-card').forEach(el => {
    const card = el as HTMLElement;
    
    card.addEventListener('mousemove', (e) => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg rotation
      const rotateY = ((x - centerX) / centerX) * 10;
      
      card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
      card.style.zIndex = "100";
    });

    card.addEventListener('mouseleave', () => {
      card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
      card.style.zIndex = "10";
    });
  });
</script>

<style>
  .project-card-container {
      /* Apply random rotation via astro style, but add parallax via var */
      transform: translate3d(var(--parallax-x, 0), var(--parallax-y, 0), 0) rotate(var(--rotation, 0deg));
      transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  /* Static Noise Effect */
  .drag-handle::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
      opacity: 0;
      pointer-events: none;
      mix-blend-mode: hard-light;
      transition: opacity 0.1s;
      z-index: 20;
  }

  .group:hover .drag-handle::after {
      opacity: 0.4;
      animation: static-shift 0.2s infinite steps(4);
  }

  @keyframes static-shift {
      0% { background-position: 0 0; }
      25% { background-position: -10px 10px; }
      50% { background-position: 10px -10px; }
      75% { background-position: -5px -5px; }
      100% { background-position: 0 0; }
  }

  .interactive-card {
      transition: transform 0.1s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease;
      transform-style: preserve-3d;
  }
  
  /* Ensure cards dont overlap too badly on mobile by forcing stack */
  @media (max-width: 768px) {
    .absolute {
      position: relative !important;
      top: auto !important;
      left: auto !important;
      transform: none !important;
      margin: 2rem auto;
    }
    
    .project-card-container {
        transform: none !important;
    }
  }
</style>
