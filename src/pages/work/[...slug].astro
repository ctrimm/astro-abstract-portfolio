---
import BaseLayout from '@layouts/BaseLayout.astro';
import Button from '@components/ui/Button.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

type ProjectEntry = CollectionEntry<'projects'>;

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project: ProjectEntry) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project }: { project: ProjectEntry } = Astro.props;
const { Content } = await project.render();
const { title, description, technologies, client, liveUrl, category, heroImage } = project.data;

// Get all projects for navigation
const allProjects = await getCollection('projects');
const sortedProjects = allProjects.sort(
  (a: ProjectEntry, b: ProjectEntry) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);
const currentIndex = sortedProjects.findIndex((p: ProjectEntry) => p.id === project.id);
const projectNumber = (currentIndex + 1).toString().padStart(2, '0');
const prevProject = sortedProjects[currentIndex - 1];
const nextProject = sortedProjects[currentIndex + 1];
---

<BaseLayout title={`${title} | Work`} description={description}>
  <!-- Back Navigation -->
  <section class="py-8 border-b border-gray-200">
    <div class="container mx-auto px-8">
      <a
        href="/work/"
        class="inline-flex items-center gap-2 text-sm hover:opacity-70 transition-opacity"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Projects
      </a>
    </div>
  </section>

  <!-- Project Header -->
  <section class="py-12 md:py-20">
    <div class="container mx-auto px-8">
      <div class="max-w-4xl">
        <div class="mb-6">
          <span class="text-sm text-gray-500">/{projectNumber}</span>
        </div>
        <h1 class="text-5xl md:text-6xl lg:text-7xl font-bold mb-8">
          {title}
        </h1>
      </div>
    </div>
  </section>

  <!-- Project Hero Image -->
  <section class="pb-12 md:pb-20">
    <div class="container mx-auto px-8">
      <div class="relative aspect-video bg-gray-100 rounded-lg overflow-hidden">
        {heroImage ? (
          <img src={heroImage} alt={title} class="w-full h-full object-cover" />
        ) : (
          <div class="w-full h-full flex items-center justify-center">
            <div class="text-center p-12">
              <div class="text-6xl mb-4">üé®</div>
              <p class="text-gray-600">Project hero image</p>
            </div>
          </div>
        )}
        
        <!-- Category Badge -->
        <div class="absolute top-6 left-6 bg-black text-white px-4 py-2 rounded-full text-sm font-medium">
          {category.replace(/-/g, ' ')}
        </div>
      </div>
    </div>
  </section>

  <!-- Project Details Grid -->
  <section class="py-12 border-t border-gray-200">
    <div class="container mx-auto px-8">
      <div class="grid md:grid-cols-2 gap-12">
        <!-- Left Column: Project Info -->
        <div class="space-y-8">
          {client && (
            <div>
              <h3 class="text-sm font-semibold mb-3 uppercase tracking-wider text-gray-500">Client</h3>
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                  <span class="text-lg">üë§</span>
                </div>
                <div>
                  <p class="font-semibold">{client}</p>
                  <p class="text-sm text-gray-600">Founder of {client}</p>
                </div>
              </div>
            </div>
          )}

          <div>
            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wider text-gray-500">Description</h3>
            <p class="text-lg leading-relaxed">{description}</p>
          </div>

          <div>
            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wider text-gray-500">Technologies</h3>
            <div class="flex flex-wrap gap-2">
              {technologies.map((tech: string) => (
                <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                  {tech}
                </span>
              ))}
            </div>
          </div>

          {liveUrl && (
            <div>
              <Button href={liveUrl} variant="primary" external>
                View Live Site ‚Üí
              </Button>
            </div>
          )}
        </div>

        <!-- Right Column: Project Content -->
        <div class="prose prose-lg max-w-none">
          <Content />
        </div>
      </div>
    </div>
  </section>

  <!-- Navigation -->
  <section class="py-12 border-t border-gray-200">
    <div class="container mx-auto px-8">
      <div class="flex justify-between items-center">
        {prevProject ? (
          <a href={`/work/${prevProject.id}/`} class="group text-left">
            <span class="text-sm text-gray-500 block mb-1">‚Üê Previous</span>
            <span class="font-semibold group-hover:opacity-70 transition-opacity">
              {prevProject.data.title}
            </span>
          </a>
        ) : <div />}

        {nextProject && (
          <a href={`/work/${nextProject.id}/`} class="text-right group">
            <span class="text-sm text-gray-500 block mb-1">Next ‚Üí</span>
            <span class="font-semibold group-hover:opacity-70 transition-opacity">
              {nextProject.data.title}
            </span>
          </a>
        )}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .prose {
    @apply text-gray-700;
  }

  .prose :global(h2) {
    @apply text-black font-bold text-2xl mt-8 mb-4;
  }

  .prose :global(h3) {
    @apply text-black font-semibold text-xl mt-6 mb-3;
  }

  .prose :global(p) {
    @apply mb-4 leading-relaxed;
  }

  .prose :global(ul),
  .prose :global(ol) {
    @apply mb-4 ml-6;
  }

  .prose :global(li) {
    @apply mb-2;
  }

  .prose :global(strong) {
    @apply text-black font-semibold;
  }

  .prose :global(a) {
    @apply text-black underline hover:no-underline;
  }
</style>
