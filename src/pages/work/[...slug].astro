---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry, render } from 'astro:content';
import { getPath } from '@/utils/paths';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project: any) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

type ProjectEntry = CollectionEntry<'projects'>;
const { project } = Astro.props as { project: ProjectEntry };
const { Content } = await render(project);
const { title, description, technologies, client, liveUrl, category, heroImage } = project.data;

const allProjects = await getCollection('projects');
const sortedProjects = allProjects.sort(
  (a: ProjectEntry, b: ProjectEntry) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);
const currentIndex = sortedProjects.findIndex((p: ProjectEntry) => p.id === project.id);
const prevProject = sortedProjects[currentIndex - 1];
const nextProject = sortedProjects[currentIndex + 1];
---

<BaseLayout title={`${title} | Work`} description={description}>
  <div class="min-h-screen bg-white text-black">
    <!-- Project Header -->
    <header class="border-b-8 border-black pt-20 pb-8 px-4 relative overflow-hidden">
        <div class="absolute top-0 right-0 font-display text-[20vw] opacity-5 leading-none pointer-events-none select-none">
            {category.split('-')[0]}
        </div>
        
        <div class="relative z-10">
            <div class="flex flex-wrap gap-4 mb-4 font-mono text-sm uppercase">
                <span class="bg-black text-white px-2 py-1">PROJECT_ID: {project.id}</span>
                <span class="border-2 border-black px-2 py-1">CLIENT: {client || 'UNKNOWN'}</span>
            </div>
            
            <h1 class="font-display text-6xl md:text-9xl uppercase leading-none break-words mb-8">
                {title}
            </h1>
            
            <p class="font-mono text-xl md:text-2xl max-w-4xl border-l-8 border-black pl-6">
                {description}
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="grid md:grid-cols-[1fr_2fr] gap-0 border-b-8 border-black">
        <!-- Sidebar Meta -->
        <aside class="border-b-8 md:border-b-0 md:border-r-8 border-black p-8 space-y-12">
            <div>
                <h3 class="font-display text-2xl uppercase mb-4 bg-black text-white inline-block px-2">Tech Stack</h3>
                <div class="flex flex-wrap gap-2">
                    {technologies.map((tech: string) => (
                        <span class="font-mono text-sm border-2 border-black px-2 py-1 hover:bg-black hover:text-white transition-colors cursor-default">
                            {tech}
                        </span>
                    ))}
                </div>
            </div>
            
            {liveUrl && (
                <div>
                    <h3 class="font-display text-2xl uppercase mb-4 bg-black text-white inline-block px-2">Deployment</h3>
                    <a href={liveUrl} target="_blank" class="block font-mono text-lg underline decoration-4 hover:bg-black hover:text-white transition-colors w-max p-1">
                        LAUNCH_SITE ->
                    </a>
                </div>
             )}
             
             <div class="p-4 border-4 border-black bg-gray-100">
                 <div class="font-mono text-xs mb-2">STATUS:</div>
                 <div class="font-display text-xl uppercase text-black animate-pulse">COMPLETED</div>
             </div>
        </aside>

        <!-- Gallery / Content -->
        <article class="p-8 md:p-12 prose-brutalist">
            {heroImage && (
                <div class="border-8 border-black mb-12 shadow-[16px_16px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:translate-x-4 hover:translate-y-4 transition-all relative group overflow-hidden">
                    <img src={heroImage} alt={title} class="w-full h-auto grayscale block" />
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\' opacity=\'0.5\'/%3E%3C/svg%3E')] opacity-0 group-hover:opacity-40 mix-blend-hard-light pointer-events-none z-10"></div>
                </div>
            )}
            
            <div class="font-mono leading-relaxed max-w-none text-lg">
                <Content />
            </div>
        </article>
    </div>

    <!-- Navigation -->
    <nav class="grid grid-cols-2 text-center font-display text-2xl md:text-4xl uppercase">
        {prevProject ? (
            <a href={getPath(`/work/${prevProject.id}/`)} class="border-r-4 border-black p-8 hover:bg-black hover:text-white transition-colors flex flex-col justify-center min-h-[150px]">
                <span class="text-sm font-mono block mb-2 opacity-50">&lt;- PREV</span>
                {prevProject.data.title}
            </a>
        ) : (
            <div class="border-r-4 border-black bg-gray-200"></div>
        )}
        
        {nextProject ? (
            <a href={getPath(`/work/${nextProject.id}/`)} class="p-8 hover:bg-black hover:text-white transition-colors flex flex-col justify-center min-h-[150px]">
                <span class="text-sm font-mono block mb-2 opacity-50">NEXT -></span>
                {nextProject.data.title}
            </a>
        ) : (
            <div class="bg-gray-200"></div>
        )}
    </nav>
  </div>
</BaseLayout>

<style is:global>
    /* Brutalist Typography for Content */
    .prose-brutalist h1, 
    .prose-brutalist h2, 
    .prose-brutalist h3 {
        @apply font-display uppercase mt-12 mb-6;
    }
    
    .prose-brutalist h2 { @apply text-4xl; }
    .prose-brutalist h3 { @apply text-2xl border-b-4 border-black pb-2 inline-block; }
    
    .prose-brutalist p { @apply mb-6; }
    .prose-brutalist ul { @apply list-disc list-inside mb-6 font-bold; }
    .prose-brutalist a { @apply underline decoration-4 hover:bg-black hover:text-white transition-colors; }
    .prose-brutalist img { @apply border-4 border-black my-8; }
</style>
